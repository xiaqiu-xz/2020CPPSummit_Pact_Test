name: Consumer

on: [push]

jobs:
  # ─────────────────────────────────────────
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version

      - run: mkdir -p consumer/build

      # Conan 缓存
      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: ${{ runner.os }}-conan2-${{ hashFiles('consumer/conanfile.txt') }}
          restore-keys: ${{ runner.os }}-conan2-

      # 安装 Conan v2
      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install conan
          conan --version

      # 安装 Rust（如果依赖需要从源码编译）
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # ✅ Conan v2 正确用法
      - name: Conan install dependencies
        working-directory: consumer/build
        run: |
          conan profile detect --force
          conan install ../conanfile.txt \
            --build=missing \
            --settings compiler.cppstd=17 \
            --output-folder=.

      # ✅ CMake 必须传入 conan_toolchain.cmake
      - name: Build
        working-directory: consumer/build
        run: |
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Run tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG
        run: test/bin/pact-consumer-tests || true

  # ─────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version
      - run: mkdir -p consumer/build

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~\.conan2
          key: ${{ runner.os }}-conan2-${{ hashFiles('consumer/conanfile.txt') }}
          restore-keys: ${{ runner.os }}-conan2-

      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install conan
          conan --version

      - name: Install Rust
        run: |
          curl -sSf -o rustup-init.exe https://win.rustup.rs/x86_64
          ./rustup-init.exe -y --default-toolchain stable --profile minimal
          echo "$USERPROFILE/.cargo/bin" >> $GITHUB_PATH

      - name: Conan install dependencies
        working-directory: consumer/build
        run: |
          conan profile detect --force
          conan install ../conanfile.txt \
            --build=missing \
            --settings compiler.cppstd=17 \
            --output-folder=.

      - name: Build
        working-directory: consumer/build
        run: |
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake
          cmake --build . --config Release
          # Windows 需要把 dll 拷贝到 exe 旁边
          cp pact_ffi/pact_ffi.dll test/bin/ 2>/dev/null || true


      - name: Run tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG
        run: test/bin/pact-consumer-tests || true

  # ─────────────────────────────────────────
  build-osx:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python3 --version
      - run: mkdir -p consumer/build

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: ${{ runner.os }}-conan2-${{ hashFiles('consumer/conanfile.txt') }}
          restore-keys: ${{ runner.os }}-conan2-

      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install conan
          conan --version

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Conan install dependencies
        working-directory: consumer/build
        run: |
          conan profile detect --force
          conan install ../conanfile.txt \
            --build=missing \
            --settings compiler.cppstd=17 \
            --output-folder=.

      - name: Build
        working-directory: consumer/build
        run: |
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Run tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG
        run: test/bin/pact-consumer-tests || true