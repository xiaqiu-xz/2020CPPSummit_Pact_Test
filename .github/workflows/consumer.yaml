name: Consumer Project

on: [push]

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version

      - name: Install latest GCC (gcc-14 on Ubuntu 24.04)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14

      - run: mkdir -p consumer/build

      - name: Install conan
        run: |
          pip3 install wheel setuptools
          pip3 install conan

      - name: Check conan version
        run: |
          export PATH=$PATH:/home/runner/.local/bin
          conan --version

      - name: conan install dependencies
        run: |
          rm -rf $HOME/.conan2/data/pact_ffi || true
          export PATH=$PATH:/home/runner/.local/bin
          conan profile detect --force
          conan remote add pact-foundation https://pactfoundation.jfrog.io/artifactory/api/conan/pactfoundation-conan --force
          # 使用最新 gcc-14 构建（通过 --settings 指定 c++17）
          conan install ../conanfile.txt --build=missing --settings compiler.cppstd=17
        working-directory: consumer/build
        env:
          CC: gcc-14     # 使用最新版本（或去掉，让默认生效）
          CXX: g++-14

      - name: Build library
        run: |
          cmake .. -DCMAKE_C_COMPILER=gcc-14 -DCMAKE_CXX_COMPILER=g++-14
          cmake --build .
          cp ../test/example.jpg .
        working-directory: consumer/build
        env:
          CC: gcc-14
          CXX: g++-14

      - name: Run pact-consumer-tests
        run: test/bin/pact-consumer-tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version

      - run: mkdir consumer\build
        shell: bash

      - run: rm -rf $HOME/.conan2/data/pact_ffi || true
        shell: bash

      - name: Install conan
        run: |
          pip3 install wheel setuptools
          pip3 install conan

      - name: conan install dependencies Windows
        run: |
          conan remote add pact-foundation https://pactfoundation.jfrog.io/artifactory/api/conan/pactfoundation-conan --force
          conan install ../conanfile.txt --build=missing --settings compiler.cppstd=17
        working-directory: consumer/build
        shell: bash

      - name: Build library Windows
        run: |
          cmake ..
          cmake --build . --config Release
          cp ../test/example.jpg .
        shell: bash
        working-directory: consumer/build

      - name: Run pact-consumer-tests
        run: test/bin/pact-consumer-tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG

  build-osx:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version

      - run: mkdir -p consumer/build

      - name: Install conan
        run: |
          pip3 install wheel setuptools
          pip3 install conan

      - name: Check conan version
        run: |
          export PATH=$PATH:/Users/runner/.local/bin
          conan --version

      - name: conan install dependencies
        run: |
          rm -rf $HOME/.conan2/data/pact_ffi || true
          export PATH=$PATH:/Users/runner/.local/bin
          conan profile detect --force
          conan remote add pact-foundation https://pactfoundation.jfrog.io/artifactory/api/conan/pactfoundation-conan --force
          conan install ../conanfile.txt --build=missing --settings compiler.cppstd=17
        working-directory: consumer/build

      - name: Build library
        run: |
          cmake ..
          cmake --build .
          cp ../test/example.jpg .
        working-directory: consumer/build

      - name: Run pact-consumer-tests
        run: test/bin/pact-consumer-tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG