name: Consumer

on: [push]

jobs:
  # ─────────────────────────────────────────
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version

      - run: mkdir -p consumer/build

      # Conan 缓存
      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: ${{ runner.os }}-conan2-${{ hashFiles('consumer/conanfile.txt') }}
          restore-keys: ${{ runner.os }}-conan2-

      # 安装 Conan v2
      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install conan
          conan --version

      # 安装 Rust（如果依赖需要从源码编译）
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # ✅ Conan v2 正确用法
      - name: Conan install dependencies
        working-directory: consumer/build
        run: |
          conan profile detect --force
          conan install ../conanfile.txt \
            --build=missing \
            --settings compiler.cppstd=17 \
            --output-folder=.

      - name: Download pact_ffi (Linux)
        run: |
          mkdir -p consumer/build/pact_ffi
          curl -sL \
            https://github.com/pact-foundation/pact-reference/releases/download/libpact_ffi-v0.4.22/libpact_ffi-linux-x86_64.so.gz \
            -o consumer/build/pact_ffi/libpact_ffi.so.gz
          gunzip -f consumer/build/pact_ffi/libpact_ffi.so.gz
          curl -sL \
            https://github.com/pact-foundation/pact-reference/releases/download/libpact_ffi-v0.4.22/pact.h \
            -o consumer/build/pact_ffi/pact.h
          ls -la consumer/build/pact_ffi/

      # ✅ CMake 必须传入 conan_toolchain.cmake
      - name: Build
        working-directory: consumer/build
        run: |
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Run tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG
        run: test/bin/pact-consumer-tests || true

  # ─────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python --version
      - run: mkdir -p consumer/build

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~\.conan2
          key: ${{ runner.os }}-conan2-${{ hashFiles('consumer/conanfile.txt') }}
          restore-keys: ${{ runner.os }}-conan2-

      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install conan
          conan --version

      - name: Install Rust
        run: |
          curl -sSf -o rustup-init.exe https://win.rustup.rs/x86_64
          ./rustup-init.exe -y --default-toolchain stable --profile minimal
          echo "$USERPROFILE/.cargo/bin" >> $GITHUB_PATH

      - name: Conan install dependencies
        working-directory: consumer/build
        run: |
          conan profile detect --force
          conan install ../conanfile.txt \
            --build=missing \
            --settings compiler.cppstd=17 \
            --output-folder=.

      - name: Download pact_ffi (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force consumer/build/pact_ffi
          $base = "https://github.com/pact-foundation/pact-reference/releases/download/libpact_ffi-v0.4.22"
          
          # 下载并解压 dll
          Invoke-WebRequest "$base/pact_ffi-windows-x86_64.dll.gz" -OutFile "consumer/build/pact_ffi/pact_ffi.dll.gz"
          $in  = [System.IO.File]::OpenRead("consumer/build/pact_ffi/pact_ffi.dll.gz")
          $out = [System.IO.File]::Create("consumer/build/pact_ffi/pact_ffi.dll")
          $gz  = [System.IO.Compression.GZipStream]::new($in, [System.IO.Compression.CompressionMode]::Decompress)
          $gz.CopyTo($out)
          $gz.Close(); $out.Close(); $in.Close()
          
          # 下载头文件
          Invoke-WebRequest "$base/pact.h" -OutFile "consumer/build/pact_ffi/pact.h"
          
          # 下载 .lib 导入库（链接时需要）
          Invoke-WebRequest "$base/pact_ffi-windows-x86_64.dll.lib" -OutFile "consumer/build/pact_ffi/pact_ffi.lib"

      - name: Build
        working-directory: consumer/build
        run: |
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake
          cmake --build . --config Release
          # Windows 需要把 dll 拷贝到 exe 旁边
          cp pact_ffi/pact_ffi.dll test/bin/ 2>/dev/null || true


      - name: Run tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG
        run: test/bin/pact-consumer-tests || true

  # ─────────────────────────────────────────
  build-osx:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - run: cmake --version
      - run: python3 --version
      - run: mkdir -p consumer/build

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: ${{ runner.os }}-conan2-${{ hashFiles('consumer/conanfile.txt') }}
          restore-keys: ${{ runner.os }}-conan2-

      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install conan
          conan --version

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Conan install dependencies
        working-directory: consumer/build
        run: |
          conan profile detect --force
          conan install ../conanfile.txt \
            --build=missing \
            --settings compiler.cppstd=17 \
            --output-folder=.

      - name: Download pact_ffi (macOS)
        run: |
          mkdir -p consumer/build/pact_ffi
          curl -sL \
            https://github.com/pact-foundation/pact-reference/releases/download/libpact_ffi-v0.4.22/libpact_ffi-macos-x86_64.dylib.gz \
            -o consumer/build/pact_ffi/libpact_ffi.dylib.gz
          gunzip -f consumer/build/pact_ffi/libpact_ffi.dylib.gz
          curl -sL \
            https://github.com/pact-foundation/pact-reference/releases/download/libpact_ffi-v0.4.22/pact.h \
            -o consumer/build/pact_ffi/pact.h

      - name: Build
        working-directory: consumer/build
        run: |
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Run tests
        working-directory: consumer/build
        env:
          LOG_LEVEL: DEBUG
        run: test/bin/pact-consumer-tests || true