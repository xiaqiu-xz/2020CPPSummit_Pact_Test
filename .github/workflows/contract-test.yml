name: Contract Tests
on: [push, pull_request]

jobs:
  consumer-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python and Conan
        run: |
          pip install "conan<2.0"  # 针对旧版 Pact 库，1.x 兼容性更好
          conan profile new default --detect
          conan profile update settings.compiler.libcxx=libstdc++11 default
          # 添加 Pact 官方仓库，否则找不到 pact-cpp-consumer
          conan remote add pact-foundation https://pactfoundation.jfrog.io/artifactory/api/conan/pact-conan

      - name: Install Pact CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/pact-foundation/pact-standalone/master/install.sh | bash
          echo "$(pwd)/pact/bin" >> $GITHUB_PATH

      - name: Build with Conan
        run: |
          mkdir build && cd build
          # 执行安装，生成 FindBoost.cmake, Findnlohmann_json.cmake 等
          conan install .. --build=missing
          
          # 关键点：通过 CMAKE_TOOLCHAIN_FILE 告诉 CMake 去哪里找 Conan 下载的包
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=conan_paths.cmake
          make consumer_test -j$(nproc)

      - name: Run tests
        run: |
          ./build/consumer_test