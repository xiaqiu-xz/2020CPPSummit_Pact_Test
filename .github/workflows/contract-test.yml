name: Contract Tests
on: [push, pull_request]

jobs:
  consumer-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Conan
        run: |
          pip install "conan<2.0"
          conan profile new default --detect
          conan profile update settings.compiler.libcxx=libstdc++11 default
          conan remote add pact-foundation \
            https://pactfoundation.jfrog.io/artifactory/api/conan/pact-conan

      # ✅ 修复：改用 pact-ruby-standalone，文件名和路径都正确
      - name: Install Pact CLI
        run: |
          PACT_VERSION="2.4.28"
          curl -L \
            "https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v${PACT_VERSION}/pact-${PACT_VERSION}-linux-x86_64.tar.gz" \
            -o pact.tar.gz

          # 验证下载大小（应该有几十 MB，不是 9 字节）
          ls -lh pact.tar.gz

          tar -xzf pact.tar.gz
          echo "$(pwd)/pact/bin" >> $GITHUB_PATH

      - name: Verify Pact CLI installed
        run: pact-broker --version

      - name: Build consumer tests
        run: |
          mkdir build && cd build
          conan install .. --build=missing
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make consumer_test

      - name: Run consumer tests
        run: ./build/consumer_test

      - name: Publish contracts to Pact Broker
        if: success()
        run: |
          pact-broker publish ./pacts \
            --broker-base-url "${{ secrets.PACT_BROKER_URL }}" \
            --broker-token   "${{ secrets.PACT_BROKER_TOKEN }}" \
            --consumer-app-version "${{ github.sha }}" \
            --tag "${{ github.ref_name }}"

  provider-verify:
    needs: consumer-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Pact CLI
        run: |
          PACT_VERSION="2.4.28"
          curl -L \
            "https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v${PACT_VERSION}/pact-${PACT_VERSION}-linux-x86_64.tar.gz" \
            -o pact.tar.gz
          tar -xzf pact.tar.gz
          echo "$(pwd)/pact/bin" >> $GITHUB_PATH

      - name: Start provider service
        run: |
          if [ -f docker-compose.yml ]; then
            docker-compose up -d todo-service
            # 等待服务健康
            timeout 60 bash -c \
              'until curl -sf http://localhost:8080/health; do sleep 2; done'
          fi

      - name: Build and run provider verification
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make provider_test
          ./provider_test

      - name: Can I Deploy check
        if: always()
        run: |
          pact-broker can-i-deploy \
            --broker-base-url "${{ secrets.PACT_BROKER_URL }}" \
            --broker-token   "${{ secrets.PACT_BROKER_TOKEN }}" \
            --pacticipant TodoService \
            --version "${{ github.sha }}"